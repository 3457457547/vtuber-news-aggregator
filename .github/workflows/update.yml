name: æ–°äººVTuberç™ºæ˜ - è‡ªå‹•åé›† & ã‚µã‚¤ãƒˆæ›´æ–°

on:
  schedule:
    # æ¯æ—¥ 9:00 JST (0:00 UTC) ã«å€™è£œã‚’åé›†
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      mode:
        description: 'å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰'
        required: true
        default: 'collect'
        type: choice
        options:
          - collect      # å€™è£œåé›† + HTMLç”Ÿæˆ
          - approve-all  # å…¨å€™è£œã‚’ä¸€æ‹¬æ‰¿èª + HTMLç”Ÿæˆ
          - generate     # HTMLç”Ÿæˆã®ã¿
          - status       # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Python ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pip install -r requirements.txt

      - name: ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          TWITTER_CONSUMER_KEY: ${{ secrets.TWITTER_CONSUMER_KEY }}
          TWITTER_CONSUMER_SECRET: ${{ secrets.TWITTER_CONSUMER_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        run: |
          MODE=${{ github.event.inputs.mode || 'collect' }}
          python scrape.py $MODE

      - name: å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ & ãƒ—ãƒƒã‚·ãƒ¥
        run: |
          git config user.name "VTuber Discovery Bot"
          git config user.email "bot@vtuber-matome.net"
          git add -A
          TIMESTAMP=$(TZ=Asia/Tokyo date '+%Y/%m/%d %H:%M JST')
          if git diff --staged --quiet; then
            echo "å¤‰æ›´ãªã—ã€ã‚¹ã‚­ãƒƒãƒ—"
          else
            git commit -m "ğŸ” è‡ªå‹•æ›´æ–°: ${TIMESTAMP}"
            git push
          fi
